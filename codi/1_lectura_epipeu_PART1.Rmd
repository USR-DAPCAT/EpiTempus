---
title: 'Pharmacological Treatment at the start of TYPE 2 diabetes mellitus in Catalonia.'
author: "Jordi Real & Rai Puig"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_origen: "../../DADES/EPIPEU_CAT3/dades/mostra" # "../DADES/EPIPEU_CAT3/dades/mostra"
  dir_dades_desti: "dades/mostra" # dades/mostra"  # dades 
---


&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>



<div class="watermark">DRAFT</div>




# FASE LECTURA

>> Generacion de tabla plana y aplicacion de los primeros criterios inclusion 

```{r setup, include = FALSE}
#rm(list=ls())
library(dplyr)
# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

#conductor_codis<-here::here("codis_peucat.xlsx")

#[17.02.2021]
conductor_codis<-here::here("CATALEG_PROYECTO_Manel.xlsx")
#[15.10.2021]
conductor_codis2<-here::here("CATALEG_PROYECTO_epitempus.xlsx")

directori_dades_origen<-params$dir_dades_origen




#   template: template.html
#

```
## 1. Lectura 
```{r lectura, include=T}
# 1 Lectura -----------

dt_cataleg<-readxl::read_excel(conductor_codis2,col_types = "text")%>%select(cod,agr,AGR1)


dt_cataleg2<-readxl::read_excel(conductor_codis,col_types = "text")%>%select(domini,cod,DM2,agr0,agr,agr_Farmac0A,agr_Farmac0B,agr_Farmac0C,agr_Farmac0D,agr_Farmac1,agr_Farmac2,agr_Farmac3,agr_Niad,agr_Insul_Ado,agr_Comp_Vasc,agr_CVD,agr_Comp_Vasc2)





#12.Xii.2020
dt_diagnostics_HOSP<-readRDS(here::here(directori_dades_origen,"epiPEUCAT_entregable_cmbdh_diagnostics_20200206_104913.rds")) %>% as_tibble()

#26.xii.2020[2Entrega]
dt_diagnostics_HOSP2<-data.table::fread(here::here(directori_dades_origen,"epiPEUCAT_PX_entregable_cmbdh_diagnostics_20210104_131331.txt"))%>%as_tibble()%>%select(-cingres)%>%select(idp,cod,dat,dx_pos,dalta,calta,id_ingres,origen,codificacio,agr)

dt_diagnostics_HOSP<-dt_diagnostics_HOSP%>%
  select(idp,cod,dat,agr)%>%
  bind_rows(select(dt_diagnostics_HOSP2,idp,cod,dat,agr))

dt_diagnostics_AP<-readRDS(here::here(directori_dades_origen,"epiPEUCAT_entregable_diagnostics_20200206_104913.rds")) %>% as_tibble()
dt_derivacions<-readRDS(here::here(directori_dades_origen,"epiPEUCAT_entregable_derivacions_20200206_104913.rds")) %>% as_tibble()


dt_poblacio<-readRDS(here::here(directori_dades_origen,"epiPEUCAT_entregable_poblacio_20200206_104913.rds")) %>% as_tibble()

dt_tabaquisme<-readRDS(here::here(directori_dades_origen,"epiPEUCAT_entregable_tabaquisme_20200206_104913.rds")) %>% as_tibble()
dt_analitiques<-readRDS(here::here(directori_dades_origen,"epiPEUCAT_entregable_variables_analitiques_20200206_104913.rds")) %>% as_tibble()
dt_cliniques<-readRDS(here::here(directori_dades_origen,"epiPEUCAT_entregable_variables_cliniques_20200206_104913.rds")) %>% as_tibble()

# Fusiono cliniques + variables

dt_variables<-dt_analitiques%>% bind_rows(dt_cliniques) %>% select(-agr) %>% 
  left_join(select(dt_cataleg,cod,agr),by="cod") %>% 
  select(-cod) %>% rename(cod=agr)


#[1Entrega]
# dt_procediments<-read.csv2(here::here(directori_dades_origen,"epiPEUCAT_PX_entregable_cmbdh_procediments_20201211_095238.csv"),sep="|",dec=",",header = TRUE,stringsAsFactors=F)%>%
#   as_tibble()%>%select(idp,cod,dat,agr)


dt_procediments<-data.table::fread(here::here(directori_dades_origen,"epiPEUCAT_PX_entregable_cmbdh_procediments_20201211_095238.txt"))%>%
  as_tibble()%>%select(idp,cod,dat,agr)


#26.xii.2020[3Entrega]
dt_procediments2<-data.table::fread(here::here(directori_dades_origen,"epiPEUCAT_PX_entregable_cmbdh_procediments_20210104_131331.txt"))%>%
  as_tibble()%>%select(idp,cod,dat,agr)



# fer-ho dema 26.01.2021
#
#
#i)   epiPEUCAT_PX_entregable_cmbdh_diagnostics_20210104_131331
#ii)  epiPEUCAT_PX_entregable_cmbdh_procediments_20201211_095238
#iii) epiPEUCAT_PX_entregable_cmbdh_procediments_20210104_131331

# ho he fet 18.12.2020
# Fusiono dt_diagnostics (E-CAP + Hospital1+Hospital2+Procediments )
dt_diagnostics_AP_HOSP<-dt_diagnostics_AP%>%transmute(idp,cod=as.character(cod),dat,agr)%>%
  bind_rows(select(dt_diagnostics_HOSP,idp,cod,dat,agr))%>%
  bind_rows(dt_procediments)%>%bind_rows(dt_procediments2)



dt_facturacio<-readRDS(here::here(directori_dades_origen,"epiPEUCAT_entregable_farmacs_facturats_20200206_104913.rds")) %>% as_tibble()



```

```{r netejar_fitxers}

rm(dt_diagnostics_AP,dt_diagnostics_HOSP,dt_diagnostics_HOSP2,dt_procediments,dt_procediments2)

rm(dt_analitiques,dt_cliniques)

gc()


```



## 2. Agregacion de datos
```{r genero_1_FILTRE}

#[13.10.2021]#: Filtrem pacients (2007-2018)
dt_poblacio<-
  dt_poblacio  %>%
  filter(entrada>=20060101 & sortida<=20181231)  

gc()

```

```{r , include=F}
#dtagr_INCLUSIONS_2018_EPIPEU_AP_HOSP<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                           bd.dindex = 20181231,
#                                           dt.agregadors=select(dt_cataleg3,cod,agr=DM2),
#                                           finestra.dies=c(-Inf,0),prefix = "INCLUSIO.",cataleg_mana=T)%>%select(-dtindex)
```


```{r generacio_dtindex, include=F}



# codis de farmacs antidiabetics considerats
#################################################################################################################################################################
dt_temp1<-
  dt_cataleg2%>% filter(domini=="farmacs_facturats") %>% select(cod,agr=agr_Farmac1) %>% filter(!is.na(agr)) 
dt_temp2<-
  dt_cataleg2%>% filter(domini=="farmacs_facturats") %>% select(cod,agr=agr_Farmac2) %>% filter(!is.na(agr))
dt_temp3<-
  dt_cataleg2%>% filter(domini=="farmacs_facturats") %>% select(cod,agr=agr_Farmac3) %>% filter(!is.na(agr))
dt_temp4<-
  dt_cataleg2%>% filter(domini=="farmacs_facturats") %>% select(cod,agr=agr_Insul_Ado) %>% filter(!is.na(agr))

dt_temp1<-dt_temp1 %>% bind_rows(dt_temp2) %>% bind_rows(dt_temp3) %>% bind_rows(dt_temp4) %>% distinct()

#################################################################################################################################################################
dt_temp1 %>% arrange(agr) %>% kable(caption = "Codis ATC considerats per identificar debut/diagnostic de la diabetis tipo 2") %>% kableExtra::kable_classic_2()
#################################################################################################################################################################


#################################################################################################################################################################
dt_cataleg3<-dt_cataleg  %>% filter(AGR1=="DM2_incusion")
#################################################################################################################################################################



#################################################################################################################################################################
# Diagnòtic DM2
#dt_index1<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                           bd.dindex = 20181231,
#                                           dt.agregadors=select(dt_cataleg2,cod,agr=DM2),
#                                           finestra.dies=c(-Inf,0),prefix = "INCLUSIO.",cataleg_mana=T) %>%  select(idp,dtindex=INCLUSIO.DM2) 

dt_index1<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
                                           bd.dindex = 20181231,
                                           dt.agregadors=select(dt_cataleg3,cod,agr=AGR1),
                                           finestra.dies=c(-Inf,0),prefix = "INCLUSIO.",cataleg_mana=T) %>%  select(idp,dtindex=INCLUSIO.DM2_incusion) 



#################################################################################################################################################################
# Fàrmac
#dt_index2<- 
#  dt_facturacio %>% agregar_facturacio(finestra.dies = c(-Inf,0),
#                                     dt.agregadors = dt_temp1 %>% transmute(cod,agr="Antidiabetic"),
#                                     prefix = "",camp_agregador="agr",agregar_data=T) %>% 
#                                     transmute(idp,dtindex=data.to.string(Antidiabetic) %>% as.numeric())

dt_index2<- 
  dt_facturacio %>% agregar_facturacio(finestra.dies = c(-Inf,0),
                                     dt.agregadors=select(dt_cataleg3,cod,agr=AGR1),
                                     prefix = "INCLUSIO.",camp_agregador="agr",agregar_data=T)%>%  
                                     transmute(idp,dtindex=data.to.string(INCLUSIO.DM2_incusion) %>% as.numeric())



#################################################################################################################################################################
# Glicada 
#dt_index3<- 
#  dt_variables %>% filter(cod=="GLICADA") %>% filter(val>=6.5) %>% group_by(idp) %>% slice(which.min(dat)) %>% ungroup() %>% 
#  select(idp,dtindex=dat)

dt_index3<- 
  dt_variables %>% filter(cod=="GLICADA") %>% filter(val>=6.5) %>% group_by(idp) %>% slice(which.min(dat)) %>% ungroup() %>% 
  select(idp,dtindex=dat)

#################################################################################################################################################################



# Fusió de tot 
dt_index<-
  dt_index1 %>% bind_rows(dt_index2) %>% bind_rows(dt_index3) %>% 
  group_by(idp) %>%  slice(which.min(dtindex)) %>% ungroup() 




rm(dt_temp1,dt_temp2,dt_temp3,dt_temp4,dt_index1,dt_index2,dt_index3)


dt_cataleg3%>% arrange(agr) %>% kable(caption = "Codis ATC considerats per identificar debut/diagnostic de la diabetis tipo 2") %>% kableExtra::kable_classic_2()



```

```{r agregacio_diagnostics1 ,include=F}


###############################################################################################################################
dtagr_problemes_2018_EPIPEU_AP_HOSP1<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
                                        bd.dindex = dt_index,
                                        dt.agregadors=select(dt_cataleg,cod,agr=AGR1),
                                        finestra.dies=c(-Inf,0),prefix = "DG.",cataleg_mana=T)%>%select(-dtindex)
###############################################################################################################################
###############################################################################################################################
#dtagr_problemes_2018_EPIPEU_AP_HOSP2<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex = dt_index,
#                                        dt.agregadors=select(dt_cataleg,cod,agr=agr),
#                                        finestra.dies=c(-Inf,0),prefix = "DG.",cataleg_mana=T)%>%select(-dtindex)
################################################################################################################################




#dtagr_problemes_2018_EPIPEU_AP_HOSP1a<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex = dt_index,
#                                        dt.agregadors=select(dt_cataleg2,cod,agr),
#                                        finestra.dies=c(-Inf,0),prefix = "DG.",cataleg_mana=T)%>%select(-dtindex)

#dtagr_problemes_2018_EPIPEU_AP_HOSP1b<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex =  dt_index,
#                                        dt.agregadors=select(dt_cataleg2,cod,agr=agr_Comp_Vasc),
#                                        finestra.dies=c(-Inf,0),prefix = "DG.",cataleg_mana=T)%>%select(-dtindex)

#dtagr_problemes_2018_EPIPEU_AP_HOSP1c<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex =dt_index,
#                                        dt.agregadors=select(dt_cataleg2,cod,agr=agr_CVD),
#                                        finestra.dies=c(-Inf,0),prefix = "DG.",cataleg_mana=T)%>%select(-dtindex)


#dtagr_problemes_2018_EPIPEU_AP_HOSP1d<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex = dt_index,
#                                        dt.agregadors=select(dt_cataleg2,cod,agr=agr_Comp_Vasc2),
#                                        finestra.dies=c(-Inf,0),prefix = "DG.",cataleg_mana=T)%>%select(-dtindex)






```


```{r agregacio_diagnostics2 ,include=F}

gc()




#dtagr_problemes_2018_EPIPEU_AP_HOSP2<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex =dtagr_INCLUSIONS_2018_EPIPEU_AP_HOSP,
#                                        dt.agregadors=select(dt_cataleg3,cod,agr=agr1),
#                                        finestra.dies=c(-365,0),prefix = "GRUP365.",cataleg_mana=T)%>%select(-dtindex)





#dtagr_problemes_2018_EPIPEU_AP_HOSP2b<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex = dtagr_INCLUSIONS_2018_EPIPEU_AP_HOSP,
#                                        dt.agregadors=select(dt_cataleg3,cod,agr=agr11),
#                                        finestra.dies=c(-365,0),prefix = "GRUP365.",cataleg_mana=T)%>%select(-dtindex)





#dtagr_problemes_2018_EPIPEU_AP_HOSP3<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex = dtagr_INCLUSIONS_2018_EPIPEU_AP_HOSP,
#                                        dt.agregadors=select(dt_cataleg3,cod,agr=agr1),
#                                        finestra.dies=c(-Inf,0),prefix = "GRUP.",cataleg_mana=T)%>%select(-dtindex)



#dtagr_problemes_2018_EPIPEU_AP_HOSP4<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
#                                        bd.dindex = dtagr_INCLUSIONS_2018_EPIPEU_AP_HOSP,
#                                        dt.agregadors=select(dt_cataleg3,cod,agr=agr1_amp),
#                                        finestra.dies=c(-365,0),prefix = "GRUP365.",cataleg_mana=T)%>%select(-dtindex)






gc()

```

## 5. Fusio 1

Fusionar part dels arxius agregats 
 
```{r fusio1}


dt_plana<-dt_index%>%
left_join(dt_poblacio,by="idp")%>%
 left_join(dtagr_problemes_2018_EPIPEU_AP_HOSP1,by=c('idp'))
  



```

## 5. Salvar part1 
```{r SALVAR}
saveRDS(dt_plana,file=here::here(params$dir_dades_desti,"dt_plana_part1a.rds"))
saveRDS(dt_index,file=here::here(params$dir_dades_desti,"dt_plana_part1b.rds"))


```

