---
title: 'Pharmacological Treatment at the start of TYPE 2 diabetes mellitus in Catalonia.'
author: "Rai Puig & Jordi Real"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    css: logos_css/usr_styles.css
    fig_caption: yes
    toc: yes
    toc_float: yes
  pdf_document: default
  word_document:
    toc: yes
params:
   dir_dades_desti: "dades/mostra" # dades/mostra"  # dades 
   ANY: '2018'
   website: https://github.com/USR-DAPCAT/
---
&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

## 0. Estado:

**Ventanas de agregaciones**

&check; INCLUSIO.DM2                [ventana.dias=c(-Inf,0)]   <br/>
&check; DG.(problemas de salud)     [ventana.dias=c(-Inf,0)]   <br/>
&check; GRUP365.UEIP                [ventana.dias=c(-365,0)]   <br/>
&check; Deriv2018.                  [ventana.dias=c(-365,0)]   <br/>
&check; FF.(Farmacos)               [ventana.dias=c(-90,0)]    <br/>
&check; F365.(Farmacos)             [ventana.dias=c(-365,0)]    <br/>
&check; Analitiques+Cliniques       [ventana.dias=c(-365,0)]   <br/>
&check; Tabaquisme                  [ventana.dias=c(-Inf,0)]   <br/>

**Ultimas actualizaciones   Mayo/ 2021** 

&check; Grafico Distribucion de los valores de la Glicada(HbA1c).      <br/>
&check; Grafico Distribucion de la fecha diagnostico.      <br/>
&check; Grafico Glicada/Terapia NIAD ADO.      <br/>
&check; Grafico Tiempo de evolucion de la diabetes/Terapia NIAD ADO.      <br/>
&check; Total.Prevencion Primaria.Prevencion Secundaria[GLICADA.valor, PAS.valor,PAD.valor, cLDL.valor].      <br/>
&check; Hemos sacado los missings de todas las variables.      <br/>
&check; Hemos sacado el PAS_PAD4, PAS_PAD4=PAS.valor<=140 & PAD.valor<=90~ 1,PAS.valor>140 & PAD.valor>90)      <br/>
&check; Hemos sacado count_NIAD_ADO_CAT~ GLICADA.valor,de 90 dias ATRAS!                    
&check; Hemos creado count_NIAD_ADO_CAT_365~ GLICADA.valor,de 365 dias ATRAS!                    <br/>
&check; Hemos creado INSUL_365~ GLICADA.valor <br/>
&check; Hemos creado count_Antidiabeticos_CAT_365~ GLICADA.valor <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<100 <br/>
&check; Hemos creado GLICADA.valor <=7 &  PAS_PAD4==1 & cLDL.valor<100 <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<100 & DG.CVD==0 <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<100 & DG.CVD==1 <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<130 & DG.CVD==0 <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<100 & DG.CVD==1 <br/>
&check; Hemos creado GLICADA.valor <=7 &  PAS_PAD4==1 & cLDL.valor<130 & DG.CVD==0 <br/>
&check; Hemos creado GLICADA.valor <=7 &  PAS_PAD4==1 & cLDL.valor<100 & DG.CVD==1 <br/>
&check; LDL sin ECV  i LDL con ECV.                           <br/>
&check; canvio de nombre  Enfermedad Renal Cronica (ERC)      <br/>
&check; Cambios de codigos en el Catalago.                    <br/>
&check; Agrupadores "Edad<75 anos" us "Edad>=75 anos".        <br/>
&check; Agregacion  CVD (Cardiovascular disease).             <br/>
&check; Tabla Descriptiva Exploratoria General/ Edad.         <br/>
&check; Tabla Descriptiva Exploratoria General/ Sexo.         <br/>

 
**Realizado**

&check; Grafico Distribucion de los valores de la Glicada(HbA1c).      <br/>
&check; Grafico Distribucion de la fecha diagnostico.      <br/>
&check; Grafico Glicada/Terapia NIAD ADO.      <br/>
&check; Grafico Tiempo de evolucion de la diabetes/Terapia NIAD ADO.      <br/>
&check; %Total.Prevencion Primaria.Prevencion Secundaria[GLICADA.valor, PAS.valor,PAD.valor, cLDL.valor].       <br/>
&check; Hemos sacado los missings de todas las variables.      <br/>
&check; Hemos sacado el PAS_PAD4, PAS_PAD4=PAS.valor<=140 & PAD.valor<=90~ 1,PAS.valor>140 & PAD.valor>90)      <br/>
&check; Hemos sacado count_NIAD_ADO_CAT~ GLICADA.valor,de 90 dias ATRAS!                    
&check; Hemos creado count_NIAD_ADO_CAT_365~ GLICADA.valor,de 365 dias ATRAS!                    <br/>
&check; Hemos creado INSUL_365~ GLICADA.valor <br/>
&check; Hemos creado count_Antidiabeticos_CAT_365~ GLICADA.valor <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<100 <br/>
&check; Hemos creado GLICADA.valor <=7 &  PAS_PAD4==1 & cLDL.valor<100 <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<100 & DG.CVD==0 <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<100 & DG.CVD==1 <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<130 & DG.CVD==0 <br/>
&check; Hemos creado GLICADA.valor <7  &  PAS_PAD3==1 & cLDL.valor<100 & DG.CVD==1 <br/>
&check; Hemos creado GLICADA.valor <=7 &  PAS_PAD4==1 & cLDL.valor<130 & DG.CVD==0 <br/>
&check; Hemos creado GLICADA.valor <=7 &  PAS_PAD4==1 & cLDL.valor<100 & DG.CVD==1 <br/>
&check; LDL sin ECV  i LDL con ECV.                           <br/>
&check; canvio de nombre  Enfermedad Renal Cronica (ERC)      <br/>
&check; Cambios de codigos en el Catalago.                    <br/>
&check; Agrupadores "Edad<75 anos" us "Edad>=75 anos".        <br/>
&check; Agregacion  CVD (Cardiovascular disease).             <br/>
&check; Tabla Descriptiva Exploratoria General/ Edad.         <br/>
&check; Tabla Descriptiva Exploratoria General/ Sexo.         <br/>
&check; Agrupadores para amputaciones y revascularizaciones.  <br/>
&check; Solo 2 grupos con ulcera/pie diabetico ( primaria+hospitales) VS .sin ulcera/pie diabetico (primaria+hospitales). <br/>
&check; Nuevas agregaciones de diagnosticos y farmacos. <br/>
&check; Programacion de nuevas recodificaciones. <br/>
&check; Tabla Descriptiva Exploratoria General, por varlidacion.  <br/>
&check; Descriptiva Exploratoria General.Todas las variables  <br/>
&check; Tabla UEIP:[Ulceras Extremidades Inferiores y/o Pie Diabetico] /UEIPA:[Ulceras Extremidades Inferiores y/o Pie Diabetico y/o Amputaciones] <br/>
&check; Descriptiva Exploratoria General.BASAL.  <br/>
&check; Descriptiva Exploratoria General.Comorbilidades.  <br/>
&check; Descriptiva Exploratoria General.Antecedentes de Pie diabetico.  <br/>
&check; Descriptiva Exploratoria General.Exploracion.  <br/>
&check; Descriptiva Exploratoria General.Laboratorio.  <br/>
&check; Descriptiva Exploratoria General.Tratamiento.  <br/>
&check; Descriptiva Exploratoria General / UEIPA .  <br/> 

**Pendiente**

&check; Revision y depuracion de errores.   <br/>

# Fase de validacion de base

## Fase Preparacion


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

gc()
# libreries i funcions
library("dplyr")
library("lubridate")
library("compareGroups")

#
#source(here::here("codi/Flowchart_Box_Final2.r"))
#source(here::here("codi/criteris_exclusio_diagrama2.r"))
#
# Descarregar funcions github -
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)
#######################################################
#conductor_codis<-here::here("codis_peucat.xlsx")
#conductor<-here::here("conductor_Epipeu.xlsx")
#
#
#
############
#17.02.2021#
############

conductor_codis<-here::here("CATALEG_PROYECTO_Manel.xlsx")
#[15.10.2021]
conductor_codis2<-here::here("CATALEG_PROYECTO_epitempus.xlsx")
conductor<-here::here("Conductor_PROYECTO_Manel_VER2.xlsx")
```


```{r llegir, include = FALSE}


#######################################################
# Llegir plana
dt_plana<-readRDS(here::here(params$dir_dades_desti,"dt_plana2.rds")) %>% as_tibble()
# Filtrem  i ELIMINEM els Difunts anteriors al 2019!
#
#
#######################################################


# Filtrem:
####################################################################################
#dt_plana<-dt_plana%>%filter(dtindex>=params$bd.dindex & dtindex<=params$bd.dindex2)
####################################################################################

#dt_plana<-dt_plana%>%filter(stringr::str_sub(dtindex,1,4)==params$ANY)


```

## 1. Flow chart 

```{r Flow chart, include=T}



flow_chart1<-criteris_exclusio_diagrama(dt=dt_plana,
                                        taulavariables=conductor,
                                        criteris = "exc_pre",
                                        ordre="exc_ordre",
                                        grups=NA,
                                        etiquetes="descripcio",
                                        sequencial = T,
                                        pob_lab=c("epiPEUCAT DM2  ","epiPEUCAT DM2 sin exclusiones"),
                                        colors=c("white","grey"),
                                        forma=c("ellipse","box"))

flow_chart1




#Apliquem les EXCLUSIONS!
dt_plana_exc<-criteris_exclusio(dt_plana,taulavariables=conductor,criteris="exc_pre")


# pregunta-ho a Jordi.
#year==params$bd.dindex
#`r params$bd.dindex`

#Apliquem que surtin els MISSINGS a les TAULES , a partir del CONDUCTOR!
dt_plana_exc<-dt_plana_exc%>%mutate_at(extreure.variables("missings",conductor,dt=dt_plana_exc),as.factor)

#Etquetem  NOMS! de les  VAR  a partir del Conductor!
dt_plana_exc<-etiquetar(dt_plana_exc,taulavariables=conductor)


```

## 2. Descriptiva CODIGOS ATC.

```{r Resultats0, include=T}



#ia)
formula_Taula00_1<-formula.text("Taula00",y="",taulavariables = conductor,dt=dt_plana_exc)



#ib) Age_group
formula_taula00_2<-formula.text("Taula00",y="age6.cat",taulavariables = conductor,dt=dt_plana_exc)

#ic) Gender 
formula_taula00_3<-formula.text("Taula00",y="sexe",taulavariables= conductor,dt=dt_plana_exc)

#


```

## 3. Descriptiva Exploratoria General.

```{r resultats1, include=T}

#library("MASS")

hist(dt_plana_exc$GLICADA.valor,
     main="Distribucion de los valores de la Glicada (HbA1c)",
     xlab="Valor del HbA1c mas proximo un ano atras de cada paciente   ",
     ylab="Frecuencia ",
     col="green",
     freq=T,
     xlim=c(3,15) ,
     breaks = 1000,
         )


dt_plana_exc$ENTRADA2<-as.character(dt_plana_exc$entrada)
dt_plana_exc$DIA<-substr(dt_plana_exc$ENTRADA2,9,10)
dt_plana_exc$MES<-substr(dt_plana_exc$ENTRADA2,6,7)
dt_plana_exc$ANY<-substr(dt_plana_exc$ENTRADA2,1,4)
dt_plana_exc$ENTRADA2<-paste0(dt_plana_exc$ANY,dt_plana_exc$MES,dt_plana_exc$DIA)
#dt_plana_exc$ENTRADA2<-as.numeric(dt_plana_exc$ENTRADA2)

#barplot(dt_plana_exc$ENTRADA2)

#table(dt_plana_exc$ENTRADA2)

#t_plana_exc$DATA_DM3<-as.character(dt_plana_exc$DATA_DM2)
#dt_plana_exc$MES<-substr(dt_plana_exc$DATA_DM3,5,6)
#dt_plana_exc$ANY<-substr(dt_plana_exc$DATA_DM3,1,4)
#dt_plana_exc$DATA_DM3<-paste0(dt_plana_exc$ANY,dt_plana_exc$MES)




#barplot(table(dt_plana_exc$DATA_DM3),
#main="Distribucion de la fecha diagnostico",
#xlab="Fecha diagnostico",
#ylab="Frecuencia",
#border="red",
#col="blue",
#density=1000,
#horiz = F,
#cex.names = 0.65,
#cex.lab=0.65,
#las=2 ,
#font.axis=6
#)



#################################
# eps rectificat!: #[12.07.2021]#
#################################

dt_temporal<-dt_plana_exc%>%select(idp,PAS_PAD2b,PAS.mean,PAD.mean)%>%group_by(PAS_PAD2b)%>%summarise(min(PAS.mean),max(PAS.mean),min(PAD.mean),max(PAD.mean))%>%ungroup()
dt_temporal2<-dt_plana_exc%>%select(idp,PAS_PAD2b,PAS.mean,PAD.mean)
dt_temporal3<-dt_plana_exc%>%select(idp,PAS_PAD1b,PAS.valor,PAD.valor)%>%group_by(PAS_PAD1b)%>%summarise(min(PAS.valor),max(PAS.valor),min(PAD.valor),max(PAD.valor))%>%ungroup()
dt_temporal4<-dt_plana_exc%>%select(idp,PAS_PAD1b,PAS.valor,PAD.valor)


dt_temporal%>% as.data.frame()
dt_temporal2%>% top_n(5)%>% as.data.frame()

dt_temporal3%>% as.data.frame()
dt_temporal4%>% top_n(5)%>% as.data.frame()





formu<-formula_table1("Taula00",y="age6.cat",taulavariables=conductor,dt=dt_plana_exc)

table1::table1(formu,data = dt_plana_exc,caption="Analisis descriptivo GENERAL  por Edad.Solo variables continuas.",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"),render.missing=NULL,render.categorical="FREQ (PCTnoNA%)")



#ic) Gender 
formula_taula00_3<-formula.text("Taula00",y="sexe",taulavariables= conductor,dt=dt_plana_exc)

formu<-formula_table1("Taula00",y="sexe",taulavariables=conductor,dt=dt_plana_exc)

table1::table1(formu,
               data = dt_plana_exc,caption="Analisis descriptivo GENERAL por Sexo.Solo variables continuas.",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"),render.missing=NULL,render.categorical="FREQ (PCTnoNA%)")


```



## 3b. [E R R O R S]

```{r resultats4, include=F}

# E R R O R S !!!

print("La N es erronia. No potser que nomes 52 pacients tinguin les dades dels tres FRCV: ")
print("el 90% tenen PA, el 75% tenen HbA1c i el 75% LDL.....  ")
print("En el pitjor dels casos haurien de sortir com a minim un 50% (N > 3.200). Deu ser un problema de sintaxi")
#N=6465.

#print("GLICADA.valor")
#summary(dt_plana_exc$GLICADA.valor)
#NA's(1525 )
#print("% GLICADA.valor")
#(1-(1525/6465))*100
#print("..................................")
#print("PAS_PAD2")
#summary(dt_plana_exc$PAS_PAD2)
#NA's(1060 ) 
#print("% PAS_PAD2")
#(1-(1060/6465))*100
#print("..................................")
#print("cLDL.valor")
#summary(dt_plana_exc$cLDL.valor)
#NA's(1957 )
#print("% cLDL.valor")
#(1-(1957/6465))*100
#print("..................................")
#summary(dt_plana$DG.CVD)
#NA's(0)

```

## 4. ANEXO: Codigos  diabetes TIPO 2

```{r codis_diabetes2, include=T}

readxl::read_excel(conductor_codis2,col_types = "text")%>%select(cod,AGR1,Descripcio)%>% filter(AGR1=="DM2_incusion")%>%select(cod,Descripcio)%>% knitr::kable(caption="Códigos ICD10  y  Fármacos Diabetes TIPO 2")


```

## 5. Salvar tabla plana

```{r salvar}
saveRDS(dt_plana_exc, file=here::here(params$dir_dades_desti,"dt_plana_exc.rds"))

```
&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>



